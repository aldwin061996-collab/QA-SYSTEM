<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEW ZEALAND CREAMERY INC., QA/COA Approver</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    .status-console{height:160px;overflow:auto;background:#0b1220;color:#e6eef8;padding:10px;border-radius:10px}
    .log-pass{color:#16a34a;font-weight:600}
    .log-fail{color:#ef4444;font-weight:600}
    .log-info{color:#f59e0b;font-weight:600}
    .sig-preview{max-height:70px;max-width:240px;object-fit:contain;border:1px dashed #ddd;padding:4px;background:#fff}
    details>summary{cursor:pointer}
  </style>
</head>
<body class="bg-gray-50 text-gray-800 p-6">

<!-- LOGIN OVERLAY (only auth mechanism) -->
<div id="loginOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-xl shadow-xl w-96">
    <h2 class="text-xl font-bold mb-4 text-center">Approver Login</h2>
    <input id="overlayPass" type="password" class="w-full border rounded p-2 mb-3" placeholder="Password (default: admin123)">
    <button id="overlayLoginBtn" class="w-full px-3 py-2 bg-indigo-600 text-white rounded">Login</button>
    <p class="text-xs text-gray-500 mt-2 text-center">System is locked until login is successful.</p>
  </div>
</div>

<div id="mainApp" class="max-w-7xl mx-auto" style="display:none">
  <header class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-4">
      <img id="logoImg" src="" class="h-12 w-auto border rounded bg-white" alt="Logo"/>
      <div>
        <h1 class="text-2xl font-bold">NEW ZEALAND CREAMERY INC., QA/COA Approver</h1>
        <div class="text-xs text-gray-500">Load data from Analyst export (full DB or per-batch JSON)</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <label class="px-3 py-2 bg-gray-200 rounded cursor-pointer">Upload Logo<input id="logoUpload" type="file" accept="image/*" class="hidden"></label>
      <button id="btnExportDash" class="px-3 py-2 bg-blue-600 text-white rounded">Export Dashboard</button>
      <button id="btnExportDB" class="px-3 py-2 bg-green-600 text-white rounded">Export Database</button>
      <button id="btnExportAudit" class="px-3 py-2 bg-yellow-500 text-gray-900 rounded">Export Audit</button>
    </div>
  </header>

  <main class="grid grid-cols-3 gap-6">
    <!-- Left: Import + Signature + Console -->
    <section class="space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="font-semibold mb-2">Data Import / JSON</h2>
        <div class="space-y-2">
          <label class="px-3 py-2 bg-gray-200 rounded cursor-pointer">Import JSON<input id="importJSON" type="file" accept="application/json" class="hidden"></label>
          <button id="btnFromLocal" class="w-full px-3 py-2 bg-gray-200 rounded">Load from LocalStorage</button>
          <div class="text-xs text-gray-500">Accepts full <code>qa_database.json</code> or single-batch JSON from the Analyst.</div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <input id="approverName" placeholder="Approver Name" class="border rounded p-2 w-full mb-2" />
        <h2 class="font-semibold mb-2">Approver Signature</h2>
        <div class="space-y-2">
          <label class="px-3 py-2 bg-gray-200 rounded cursor-pointer">Upload Signature<input id="approverSig" type="file" accept="image/*" class="hidden"></label>
          <img id="approverSigPreview" class="sig-preview" style="display:none"/>
          <div class="text-xs text-gray-500">Stored locally and embedded in COAs.</div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="font-semibold mb-2">Status Console</h2>
        <div id="console" class="status-console"></div>
        <div class="mt-2 text-xs text-gray-500">✔ Green = Success · ⚠ Yellow = Info · ✖ Red = Error
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="font-semibold mb-2">System Control</h2>
        <button id="btnReset" class="w-full px-3 py-2 bg-red-600 text-white rounded">Reset System</button>
        <div class="text-xs text-gray-500 mt-2">⚠ This will clear all data (DB, logo, signatures) and reload the app.</div>
      </div>

</div>
      </div>
    </section>

    <!-- Right: Dashboard + Products -->
    <section class="col-span-2 space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="font-semibold text-lg">Dashboard</h2>
            <p class="text-sm text-gray-500">Samples/day & Pass/Fail summary</p>
          </div>
          <div class="flex items-center gap-2">
            <input id="search" class="border rounded p-2" placeholder="Search product or parameter..." />
            <button id="btnRefresh" class="px-3 py-2 bg-gray-200 rounded">Refresh</button>
          </div>
        </div>
        <div class="grid grid-cols-4 gap-3 mt-3">
          <div class="p-3 border rounded"><div class="text-xs text-gray-500">Products</div><div id="metricProducts" class="text-2xl font-bold">0</div></div>
          <div class="p-3 border rounded"><div class="text-xs text-gray-500">Parameters</div><div id="metricParams" class="text-2xl font-bold">0</div></div>
          <div class="p-3 border rounded"><div class="text-xs text-gray-500">Batches</div><div id="metricBatches" class="text-2xl font-bold">0</div></div>
          <div class="p-3 border rounded"><div class="text-xs text-gray-500">Pass / Fail (batches)</div><div id="metricPassFail" class="text-2xl font-bold">0 / 0</div></div>
        </div>
        <div id="dailyTableWrap" class="mt-4"></div>
      </div>

      <div id="productsWrap" class="space-y-3"></div>
    </section>
  </main>

  <footer class="mt-6 text-sm text-gray-500">Generated: <span id="generatedTime"></span></footer>
</div>

<script>
// ---------------- Keys ----------------
const LS_ANALYST = 'qa_analyst_db_v2'; // Analyst module storage key
const LS_APPROVER = 'qa_approver_db_v1';
const LS_LOGO = 'qa_logo_base64';
const LS_APPROVER_SIG = 'qa_approver_signature_b64';
const LS_PASS = 'qa_approver_password';

// ---------------- State ----------------
let DB = { products: [], audit: [], archive: [] };
let APPROVER_UNLOCKED = false;

// ---------------- Helpers ----------------
function now(){ return new Date().toLocaleString(); }
function uid(){ return Math.random().toString(36).slice(2,9); }
function log(type,msg){
  const c = document.getElementById('console');
  const div = document.createElement('div');
  const cls = type==='pass'?'log-pass':(type==='fail'?'log-fail':'log-info');
  div.innerHTML = `<span class='text-xs text-gray-400'>[${now()}]</span> <span class='${cls}'>${msg}</span>`;
  c.appendChild(div); c.scrollTop = c.scrollHeight;
  DB.audit = DB.audit || []; DB.audit.push({ ts: new Date().toISOString(), actor:'Approver', type, msg });
  saveDB();
}
function saveDB(){ try{ localStorage.setItem(LS_APPROVER, JSON.stringify(DB)); }catch(e){} }
function loadLogo(){ const b64 = localStorage.getItem(LS_LOGO)||''; if(b64) document.getElementById('logoImg').src = b64; }
function setLogo(file){ if(!file) return; const r=new FileReader(); r.onload=()=>{localStorage.setItem(LS_LOGO, r.result); loadLogo(); log('info','Logo updated');}; r.readAsDataURL(file); }
function setApproverSig(file){ if(!file) return; const r=new FileReader(); r.onload=()=>{ localStorage.setItem(LS_APPROVER_SIG, r.result); const img = document.getElementById('approverSigPreview'); img.src = r.result; img.style.display='block'; log('info','Approver signature updated'); }; r.readAsDataURL(file); }
function loadApproverSig(){ const b64 = localStorage.getItem(LS_APPROVER_SIG)||''; if(b64){ const img = document.getElementById('approverSigPreview'); img.src=b64; img.style.display='block'; } }

function getPass(){ return localStorage.getItem(LS_PASS) || 'admin123'; }

// ---------------- Import / Load ----------------
function importJSONFile(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const incoming = JSON.parse(reader.result);
      if(!incoming || typeof incoming !== 'object') throw new Error('Invalid JSON');

      // Case 1: Full DB (qa_database.json)
      if(Array.isArray(incoming.products)){
        if(!incoming.audit) incoming.audit=[];
        if(!incoming.archive) incoming.archive=[];
        DB = incoming;
        log('pass','Imported full Analyst database JSON');
      }
      // Case 2: Single batch export
      else if(incoming.product && incoming.batch && Array.isArray(incoming.parameters)){
        const prodId = incoming.product.id;
        let prod = DB.products.find(p=>p.id===prodId);
        if(!prod){
          prod = { id: prodId, name: incoming.product.name, parameters: [], batches: [] };
          DB.products.push(prod);
        }
        // Merge parameters
        for(const prm of incoming.parameters){
          if(!prod.parameters.some(pp=>pp.name===prm.parameter)){
            prod.parameters.push({ id: uid(), name: prm.parameter, min: prm.std_min, max: prm.std_max, unit: prm.unit });
          }
        }
        // Build results map
        const resultsMap = {};
        for(const prm of incoming.parameters){ resultsMap[prm.parameter] = prm.result; }
        // Add batch
        const b = incoming.batch;
        prod.batches.push({
          id: b.id || uid(),
          batch: b.batch_no,
          date: b.production_date,
          analysisDate: b.analysis_date,
          analyst: b.analyst,
          remarks: b.remarks,
          signature: b.signature_base64,
          results: resultsMap,
          createdAt: b.created_at || new Date().toISOString(),
          approved: false
        });
        log('pass',`Imported batch JSON for ${prod.name} / ${b.batch_no}`);
      }
      else{
        throw new Error('Unsupported JSON schema');
      }

      saveDB();
      renderAll();
    }catch(e){ alert('Import failed: '+e.message); log('fail','Import failed: '+e.message); }
  };
  reader.readAsText(file);
}

function loadFromLocalAnalyst(){
  try{
    const raw = localStorage.getItem(LS_ANALYST);
    if(!raw) return alert('No Analyst data found in this browser. Import JSON instead.');
    const incoming = JSON.parse(raw);
    if(!incoming || !Array.isArray(incoming.products)) return alert('Invalid Analyst schema.');
    if(!incoming.audit) incoming.audit=[];
    if(!incoming.archive) incoming.archive=[];
    DB = incoming; saveDB(); renderAll(); log('pass','Loaded Analyst data from LocalStorage');
  }catch(e){ alert('Load failed'); }
}

// ---------------- Dashboard ----------------
function productBatchPassFail(p,b){
  if(!p.parameters.length) return {pass:0, fail:0, status:'n/a'};
  let allHave=true, allPass=true;
  for(const prm of p.parameters){
    const v = b.results?.[prm.name];
    if(v===undefined || v===''){ allHave=false; continue; }
    if(!(v>=prm.min && v<=prm.max)) allPass=false;
  }
  if(!allHave) return {pass:0, fail:0, status:'partial'};
  return allPass?{pass:1, fail:0, status:'pass'}:{pass:0, fail:1, status:'fail'};
}

function renderDashboard(){
  const prods = DB.products||[];
  document.getElementById('metricProducts').textContent = prods.length;
  document.getElementById('metricParams').textContent = prods.reduce((a,p)=>a+p.parameters.length,0);
  document.getElementById('metricBatches').textContent = prods.reduce((a,p)=>a+p.batches.length,0);
  let pass=0, fail=0; const perDay={};
  for(const p of prods){
    for(const b of p.batches){
      const s = productBatchPassFail(p,b); pass+=s.pass; fail+=s.fail;
      const d=b.date||'Unspecified'; perDay[d]=perDay[d]||{count:0,pass:0,fail:0}; perDay[d].count++; perDay[d].pass+=s.pass; perDay[d].fail+=s.fail;
    }
  }
  document.getElementById('metricPassFail').textContent = `${pass} / ${fail}`;
  const wrap = document.getElementById('dailyTableWrap');
  const days = Object.keys(perDay).sort();
  if(!days.length){ wrap.innerHTML = '<div class="text-sm text-gray-500">No data loaded.</div>'; return; }
  let html = '<table class="w-full border mt-2"><thead><tr class="bg-gray-100">'+
    '<th class="p-2 border">Date</th><th class="p-2 border">Samples</th><th class="p-2 border">Pass</th><th class="p-2 border">Fail</th></tr></thead><tbody>';
  for(const d of days){ const r=perDay[d]; html += `<tr><td class='p-2 border'>${d}</td><td class='p-2 border text-center'>${r.count}</td><td class='p-2 border text-green-700 text-center'>${r.pass}</td><td class='p-2 border text-red-600 text-center'>${r.fail}</td></tr>`; }
  html+='</tbody></table>'; wrap.innerHTML = html;
}

function renderProducts(){
  const q = document.getElementById('search').value?.trim().toLowerCase()||'';
  const wrap = document.getElementById('productsWrap'); wrap.innerHTML='';
  for(const p of (DB.products||[])){
    const match = !q || p.name.toLowerCase().includes(q) || p.parameters.some(x=>x.name.toLowerCase().includes(q));
    if(!match) continue;
    const passCnt = p.batches.reduce((a,b)=>a+productBatchPassFail(p,b).pass,0);
    const failCnt = p.batches.reduce((a,b)=>a+productBatchPassFail(p,b).fail,0);

    const det = document.createElement('details'); det.open=true; det.className='bg-white rounded-xl shadow p-4';
    const sum = document.createElement('summary');
    sum.innerHTML = `<div class='flex items-center justify-between'>`
      + `<div><span class='font-semibold text-lg'>${p.name}</span> <span class='text-sm text-gray-500'>(${p.parameters.length} params)</span></div>`
      + `<div class='text-sm'>Pass: <span class='text-green-700 font-semibold'>${passCnt}</span> / Fail: <span class='text-red-600 font-semibold'>${failCnt}</span></div>`
      + `</div>`;
    det.appendChild(sum);

    for(const b of p.batches){
      const card = document.createElement('div'); card.className='mt-4 p-3 border rounded';
      const status = productBatchPassFail(p,b).status;
      const approval = b.approved ? `<span class='ml-2 text-green-700'>(Approved ${new Date(b.approvedAt).toLocaleString()})</span>` : `<span class='ml-2 text-yellow-700'>(Pending)</span>`;
      card.innerHTML = `<div class='flex items-center justify-between'>
        <div class='font-medium'>Batch <span class='font-semibold'>${b.batch}</span> — Production: <span class='text-gray-700'>${b.date||'-'}</span> — Analysis: <span class='text-gray-700'>${b.analysisDate||'-'}</span> — Analyst: <span class='text-gray-700'>${b.analyst||'-'}</span> ${approval}</div>
        <div class='flex items-center gap-2'>
          <span class='text-sm'>Status: ${status==='pass'?'<span class=\'text-green-700 font-semibold\'>PASS</span>':(status==='fail'?'<span class=\'text-red-600 font-semibold\'>FAIL</span>':(status==='partial'?'<span class=\'text-yellow-600 font-semibold\'>PARTIAL</span>':'—'))}</span>
          <button class='px-2 py-1 bg-yellow-500 rounded text-sm' onclick="previewCOA('${p.id}','${b.id}')">Preview</button>
          <button class='px-2 py-1 bg-indigo-600 text-white rounded text-sm' onclick="approveAndGenerate('${p.id}','${b.id}')">Approve & Generate COA</button>
        </div>
      </div>`;

      // Parameter table
      let rhtml = '<table class="w-full border mt-2"><thead><tr class="bg-gray-100">'+
        '<th class="p-2 border">Parameter</th><th class="p-2 border">Std Range</th><th class="p-2 border">Result</th><th class="p-2 border">Remarks</th></tr></thead><tbody>';
      for(const prm of p.parameters){
        const res = b.results?.[prm.name];
        let remark = '';
        if(res!==undefined && res!=='') remark = (res>=prm.min && res<=prm.max) ? '<span class="text-green-700 font-semibold">✔ Pass</span>' : '<span class="text-red-600 font-semibold">⚠ Fail</span>';
        rhtml += `<tr>
          <td class='p-2 border'>${prm.name}</td>
          <td class='p-2 border text-center'>${prm.min} – ${prm.max} ${prm.unit||''}</td>
          <td class='p-2 border text-center'>${res??''}</td>
          <td class='p-2 border text-center'>${remark}</td>
        </tr>`;
      }
      rhtml += '</tbody></table>';

      // Analyst signature preview if any
      if(b.signature){ rhtml += `<div class='mt-2'><div class='text-sm text-gray-500'>Analyst Signature:</div><img src='${b.signature}' class='sig-preview'/></div>`; }

      // Batch remarks after table
      if(b.remarks){ rhtml += `<div class='mt-2 text-sm text-gray-800'><strong>Remarks:</strong> ${b.remarks}</div>`; }

      card.innerHTML += rhtml; det.appendChild(card);
    }

    wrap.appendChild(det);
  }
}

// ---------------- COA Generation ----------------
function assertUnlocked(){ if(!APPROVER_UNLOCKED){ alert('Approver is locked. Login first.'); return false; } return true; }

function buildCOADOM(p,b){
  const logo = localStorage.getItem(LS_LOGO)||'';
  const approverSig = localStorage.getItem(LS_APPROVER_SIG)||'';
  const approverName = document.getElementById('approverName').value || '';
  const div = document.createElement('div');
  div.style.width='820px'; 
  div.style.padding='24px'; 
  div.style.background='white'; 
  div.style.fontFamily='Arial,Helvetica,sans-serif';

  // --- Header ---
  const head = document.createElement('div'); 
  head.style.textAlign = 'center';
  head.innerHTML = `
    ${logo?`<img src='${logo}' style='height:64px;display:block;margin:0 auto 8px auto'/>`:''}
    <h2 style='margin:0;font-size:16pt;font-weight:bold;'>NEW ZEALAND CREAMERY INC.</h2>
    <h2 style='margin:0;font-size:14pt;'>CERTIFICATE OF ANALYSIS</h2>
    <hr style='margin:12px 0'/>
  `;
  div.appendChild(head);

  // --- Product / Batch Details (separate section under header) ---
  const details = document.createElement('div');
  details.style.margin = '8px 0 16px 0';
  details.style.fontSize = '11pt';
  details.style.color = '#333';
  details.innerHTML = `
    <div><strong>Product:</strong> ${p.name}</div>
    <div><strong>Batch:</strong> ${b.batch}</div>
    <div><strong>Production Date:</strong> ${b.date||'-'}</div>
    <div><strong>Analysis Date:</strong> ${b.analysisDate||'-'}</div>
  `;
  div.appendChild(details);

  // --- Parameter Table ---
  const tbl = document.createElement('table'); 
  tbl.style.width='100%'; 
  tbl.style.borderCollapse='collapse';
  const trh = document.createElement('tr'); 
  trh.innerHTML = `<th style='border:1px solid #ddd;padding:6px'>Parameter</th>
                   <th style='border:1px solid #ddd;padding:6px'>Standard</th>
                   <th style='border:1px solid #ddd;padding:6px'>Result</th>
                   <th style='border:1px solid #ddd;padding:6px'>Remarks</th>`;
  tbl.appendChild(trh);
  for(const prm of p.parameters){
    const v = b.results?.[prm.name];
    const remark = (v===undefined||v==='')?'-':((v>=prm.min && v<=prm.max)?'PASS':'FAIL');
    const tr = document.createElement('tr'); 
    tr.innerHTML = `<td style='border:1px solid #ddd;padding:6px'>${prm.name}</td>
                    <td style='border:1px solid #ddd;padding:6px'>${prm.min} – ${prm.max} ${prm.unit||''}</td>
                    <td style='border:1px solid #ddd;padding:6px'>${v??''}</td>
                    <td style='border:1px solid #ddd;padding:6px'>${remark}</td>`;
    tbl.appendChild(tr);
  }
  div.appendChild(tbl);

  // --- Remarks if any ---
  if(b.remarks){ 
    const rem=document.createElement('div'); 
    rem.style.marginTop='12px'; 
    rem.style.color='#333'; 
    rem.innerHTML = `<strong>Remarks:</strong> ${b.remarks}`; 
    div.appendChild(rem); 
  }

  // --- Signatures ---
  const signWrap = document.createElement('div'); 
  signWrap.style.display='flex'; 
  signWrap.style.justifyContent='space-between'; 
  signWrap.style.marginTop='18px';
  const left = document.createElement('div'); 
  left.innerHTML = `<div style='font-weight:700'>Analyst</div>`; 
  if(b.signature){ 
    const img=document.createElement('img'); 
    img.src=b.signature; 
    img.style.maxWidth='220px'; 
    img.style.display='block'; 
    img.style.margin='6px 0'; 
    left.appendChild(img);
  } 
  left.innerHTML += `<div>${b.analyst||'-'}</div>`; 
  signWrap.appendChild(left);

  const right = document.createElement('div'); 
  right.innerHTML = `<div style='font-weight:700'>Approver</div>`; 
  if(approverSig){ 
    const img=document.createElement('img'); 
    img.src=approverSig; 
    img.style.maxWidth='220px'; 
    img.style.display='block'; 
    img.style.margin='6px 0'; 
    right.appendChild(img);
  } 
  right.innerHTML += `<div>${approverName||'-'}</div>`; 
  signWrap.appendChild(right);

  div.appendChild(signWrap);

  // --- Footer with company address ---
  const footer = document.createElement('div');
  footer.style.marginTop = '24px';
  footer.style.fontSize = '10pt';
  footer.style.textAlign = 'center';
  footer.style.color = '#444';
  footer.innerHTML = "#101 CARMELRAY BLVD., CARMELRAY INDUSTRIAL PARK 1, CANLUBANG, CALAMBA, LAGUNA, PHILIPPINES<br/>" +
                     "TEL NOS. 895-0853 / 890-4191 / FAX 895-9675 / 890-4193<br/>" +
                     "THIS IS SYSTEM GENERATED";
  div.appendChild(footer);

  return div;
}

async function generateCOA(p,b){
  const { jsPDF } = window.jspdf;
  const dom = buildCOADOM(p,b); document.body.appendChild(dom);
  try{
    const canvas = await html2canvas(dom,{scale:2});
    const imgData = canvas.toDataURL('image/jpeg',0.95);
    const pdf = new jsPDF('p','pt','a4');
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    const ratio = Math.min(pageW/canvas.width, pageH/canvas.height);
    const w = canvas.width*ratio, h = canvas.height*ratio;
    pdf.addImage(imgData,'JPEG',20,20,w-40,h-40);
    const fname = `${p.name.replace(/\\s+/g,'_')}_${(b.date||'').replace(/\\s+/g,'_')}_${b.batch.replace(/\\s+/g,'_')}_COA.pdf`;
    pdf.save(fname);
    log('pass',`Generated COA: ${fname}`);
  }catch(e){ console.error(e); log('fail','COA generation failed'); }
  document.body.removeChild(dom);
}

function previewCOA(pid,bid){
  const p = DB.products.find(x=>x.id===pid); const b = p?.batches.find(x=>x.id===bid);
  if(!p||!b) return;
  const dom = buildCOADOM(p,b); dom.style.position='fixed'; dom.style.top='20px'; dom.style.right='20px'; dom.style.zIndex='9999'; dom.style.boxShadow='0 10px 30px rgba(0,0,0,0.2)'; dom.id='coaPreviewTmp';
  const close = document.createElement('div'); close.innerHTML = '<button style="position:absolute;top:4px;right:4px;padding:6px 10px;background:#111;color:#fff;border-radius:6px">Close</button>'; close.onclick=()=>{ document.body.removeChild(dom); };
  dom.appendChild(close);
  document.body.appendChild(dom);
}

function approveAndGenerate(pid,bid){
  if(!assertUnlocked()) return;
  const approverSig = localStorage.getItem(LS_APPROVER_SIG)||'';
  if(!approverSig){ return alert('Upload Approver signature first.'); }
  const p = DB.products.find(x=>x.id===pid); const b = p?.batches.find(x=>x.id===bid);
  if(!p||!b) return;
  // Basic validations
  let missing=[]; for(const prm of p.parameters){ const v=b.results?.[prm.name]; if(v===undefined||v==='') missing.push(prm.name); }
  if(missing.length){ return alert('Missing results for: '+missing.join(', ')); }
  if(!b.signature){ return alert('Analyst signature is required before approval.'); }
  // Mark approved & archive
  b.approved = true; b.approvedAt = new Date().toISOString();
  DB.archive = DB.archive || [];
  DB.archive.push({ id: uid(), productId: p.id, batchId: b.id, product: p.name, batch: b.batch, approvedAt: b.approvedAt });
  saveDB();
  log('pass',`Approved ${p.name} / ${b.batch}`);
  generateCOA(p,b);
  renderProducts();
}

// ---------------- Exports ----------------
function exportDashboard(){
  const wb = XLSX.utils.book_new();
  // Summary sheet
  const sumRows = [['Product','Total Params','Batches','Pass','Fail']];
  for(const p of (DB.products||[])){
    const passCnt = p.batches.reduce((a,b)=>a+productBatchPassFail(p,b).pass,0);
    const failCnt = p.batches.reduce((a,b)=>a+productBatchPassFail(p,b).fail,0);
    sumRows.push([p.name, p.parameters.length, p.batches.length, passCnt, failCnt]);
  }
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sumRows), 'Dashboard Summary');
  // Daily sheet
  const perDay = {};
  for(const p of (DB.products||[])){
    for(const b of p.batches){ const s=productBatchPassFail(p,b); const d=b.date||'Unspecified'; perDay[d]=perDay[d]||{count:0,pass:0,fail:0}; perDay[d].count++; perDay[d].pass+=s.pass; perDay[d].fail+=s.fail; }
  }
  const dailyRows = [['Date','Samples','Pass','Fail']];
  for(const d of Object.keys(perDay).sort()){ const r=perDay[d]; dailyRows.push([d,r.count,r.pass,r.fail]); }
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(dailyRows), 'Per Day');
  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  XLSX.writeFile(wb, `Dashboard_Summary_${ts}.xlsx`);
  log('pass','Exported Dashboard summary');
}

function exportDB(){
  const wb = XLSX.utils.book_new();
  for(const p of (DB.products||[])){
    const rows = [];
    for(const b of p.batches){
      for(const prm of p.parameters){
        const res = b.results?.[prm.name];
        const remark = (res===undefined||res==='')?'' : ((res>=prm.min && res<=prm.max)?'Pass':'Fail');
        rows.push({ Product:p.name, Batch:b.batch, Production_Date:b.date, Analysis_Date:b.analysisDate, Analyst:b.analyst, Parameter:prm.name, Std_Min:prm.min, Std_Max:prm.max, Unit:prm.unit||'', Result:res??'', Remark:remark, Approved:b.approved? 'Yes':'No', ApprovedAt:b.approvedAt? new Date(b.approvedAt).toLocaleString():'' , Batch_Remarks:b.remarks||''});
      }
    }
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), p.name.substring(0,31));
  }
  XLSX.writeFile(wb,'QA_Database.xlsx');
  log('pass','Exported QA_Database.xlsx');
}

function exportAudit(){
  const rows = [['Timestamp','Actor','Type','Message']];
  for(const a of (DB.audit||[])){ rows.push([a.ts,a.actor,a.type,a.msg]); }
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), 'Audit');
  XLSX.writeFile(wb,'QA_Audit_Trail.xlsx');
  log('pass','Exported QA_Audit_Trail.xlsx');
}

// ---------------- Overlay Login ----------------
document.getElementById('overlayLoginBtn').addEventListener('click', ()=>{
  const pw = document.getElementById('overlayPass').value;
  if(pw === getPass()){
    APPROVER_UNLOCKED = true;
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    log('pass','Approver unlocked');
  } else {
    alert('Incorrect password');
    log('fail','Login failed');
  }
});

// ---------------- Render Root ----------------
function renderAll(){
  renderDashboard();
  renderProducts();
  document.getElementById('generatedTime').textContent = now();
}

// ---------------- Events ----------------
document.getElementById('importJSON').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(f) importJSONFile(f); e.target.value=''; });
document.getElementById('btnFromLocal').addEventListener('click', loadFromLocalAnalyst);
document.getElementById('btnRefresh').addEventListener('click', renderAll);
document.getElementById('btnExportDash').addEventListener('click', exportDashboard);
document.getElementById('btnExportDB').addEventListener('click', exportDB);
document.getElementById('btnExportAudit').addEventListener('click', exportAudit);
document.getElementById('logoUpload').addEventListener('change', (e)=> setLogo(e.target.files[0]));
document.getElementById('approverSig').addEventListener('change', (e)=> setApproverSig(e.target.files[0]));


document.getElementById('btnReset').addEventListener('click', ()=>{
  if(confirm('This will clear all Approver data, Analyst DB, logo and signatures. Continue?')){
    localStorage.removeItem(LS_APPROVER);
    localStorage.removeItem(LS_ANALYST);
    localStorage.removeItem(LS_LOGO);
    localStorage.removeItem(LS_APPROVER_SIG);
    location.reload();
  }
});

// Init
loadLogo();
loadApproverSig();
try{ const raw=localStorage.getItem(LS_APPROVER); if(raw) DB=JSON.parse(raw); }catch{}
renderAll();
log('info','Approver system initialized. Import data or load from LocalStorage.');
</script>
</body>
</html>
