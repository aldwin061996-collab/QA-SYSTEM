<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QA/COA Approver — v6 (Disposition mapped) - Patched (Fixed COA Export)</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    .status-console{height:160px;overflow:auto;background:#0b1220;color:#e6eef8;padding:10px;border-radius:10px}
    .log-pass{color:#16a34a;font-weight:600}
    .log-fail{color:#ef4444;font-weight:600}
    .log-info{color:#f59e0b;font-weight:600}
    .sig-preview{max-height:70px;max-width:240px;object-fit:contain;border:1px dashed #ddd;padding:4px;background:#fff}
    .coa-page{width:800px;margin:0 auto;background:#fff}
    .coa-table th,.coa-table td{border:1px solid #e5e7eb;padding:6px;font-size:12px}
    .watermark{position:absolute;opacity:.07;inset:0;display:flex;align-items:center;justify-content:center;font-size:120px;pointer-events:none}
    .hidden{display:none!important}
  </style>
</head>
<body class="bg-gray-50 p-6 text-gray-800">

<!-- LOGIN -->
<div id="loginOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-xl shadow-xl w-96">
    <h2 class="text-xl font-bold mb-4 text-center">Approver Login</h2>
    <input id="overlayPass" type="password" class="w-full border rounded p-2 mb-3" placeholder="Password (default: admin123)">
    <button id="overlayLoginBtn" class="w-full px-3 py-2 bg-indigo-600 text-white rounded">Login</button>
    <p class="text-xs text-gray-500 mt-2 text-center">System locked until login is successful.</p>
  </div>
</div>

<div id="mainApp" class="max-w-7xl mx-auto hidden">
  <header class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-4">
      <img id="logoImg" src="" class="h-12 w-auto border rounded bg-white" alt="Logo"/>
      <div>
        <h1 class="text-2xl font-bold">QA/COA Approver — v6</h1>
        <div class="text-xs text-gray-500">Disposition mapped strictly from JSON (batch.disposition)</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <label class="px-3 py-2 bg-gray-200 rounded cursor-pointer">Upload Logo<input id="logoUpload" type="file" accept="image/*" class="hidden"></label>
      <button id="btnExportDash" class="px-3 py-2 bg-blue-600 text-white rounded">Export Dashboard</button>
      <button id="btnExportDB" class="px-3 py-2 bg-green-600 text-white rounded">Export Database</button>
      <button id="btnExportAudit" class="px-3 py-2 bg-yellow-500 text-gray-900 rounded">Export Audit</button>
    </div>
  </header>

  <main class="grid grid-cols-3 gap-6">
    <section class="space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="font-semibold mb-2">Data Import / JSON</h2>
        <div class="space-y-2">
          <label class="px-3 py-2 bg-gray-200 rounded cursor-pointer">Import JSON<input id="importJSON" type="file" accept="application/json" class="hidden"></label>
          <button id="btnFromLocal" class="w-full px-3 py-2 bg-gray-200 rounded">Load from LocalStorage</button>
          <div class="text-xs text-gray-500 mt-2">Accepts full DB or per-batch JSON. Disposition must come from JSON.</div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <input id="approverName" placeholder="Approver Name" class="border rounded p-2 w-full mb-2" />
        <h2 class="font-semibold mb-2">Approver Signature</h2>
        <div class="space-y-2">
          <label class="px-3 py-2 bg-gray-200 rounded cursor-pointer">Upload Signature<input id="approverSig" type="file" accept="image/*" class="hidden"></label>
          <img id="approverSigPreview" class="sig-preview hidden"/>
          <div class="text-xs text-gray-500">Stored locally and embedded in COAs.</div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="font-semibold mb-2">Status Console</h2>
        <div id="console" class="status-console"></div>
        <div class="mt-2 text-xs text-gray-500">✔ Green = Success · ⚠ Yellow = Info · ✖ Red = Error</div>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="font-semibold mb-2">System</h2>
        <button id="btnReset" class="w-full px-3 py-2 bg-red-600 text-white rounded">Reset System</button>
        <div class="text-xs text-gray-500 mt-2">⚠ Clears DB, logo, signatures, and reloads.</div>
      </div>
    </section>

    <section class="col-span-2 space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="font-semibold text-lg">Dashboard</h2>
            <p class="text-sm text-gray-500">Samples/day & Pass/Fail summary</p>
          </div>
          <div class="flex items-center gap-2">
            <input id="search" class="border rounded p-2" placeholder="Search product or parameter..." />
            <button id="btnRefresh" class="px-3 py-2 bg-gray-200 rounded">Refresh</button>
          </div>
        </div>

        <div class="grid grid-cols-4 gap-3 mt-3">
          <div class="p-3 border rounded"><div class="text-xs text-gray-500">Products</div><div id="metricProducts" class="text-2xl font-bold">0</div></div>
          <div class="p-3 border rounded"><div class="text-xs text-gray-500">Parameters</div><div id="metricParams" class="text-2xl font-bold">0</div></div>
          <div class="p-3 border rounded"><div class="text-xs text-gray-500">Batches</div><div id="metricBatches" class="text-2xl font-bold">0</div></div>
          <div class="p-3 border rounded"><div class="text-xs text-gray-500">Pass / Fail (batches)</div><div id="metricPassFail" class="text-2xl font-bold">0 / 0</div></div>
        </div>

        <div id="dailyTableWrap" class="mt-4"></div>
      </div>

      <div id="productsWrap" class="space-y-3"></div>
    </section>
  </main>

  <footer class="mt-6 text-sm text-gray-500">Generated: <span id="generatedTime"></span></footer>
</div>

<!-- COA Modal -->
<div id="coaModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 items-center justify-center hidden z-50">
  <div id="coaModalContent" class="bg-white rounded-xl shadow-2xl p-4 max-w-[1000px] w-full max-h-[95vh] overflow-auto relative">
    <button id="closeCoa" class="absolute right-3 top-3 px-3 py-1 rounded bg-gray-200">Close</button>
    <div id="coaWrap" class="relative">
      <div class="watermark">DRAFT</div>
      <!-- COA content injected here -->
    </div>

    <div class="mt-4 flex gap-2">
      <button id="btnSavePDF" class="px-3 py-2 bg-indigo-600 text-white rounded">Save as PDF</button>
      <button id="btnSavePNG" class="px-3 py-2 bg-gray-800 text-white rounded">Save as PNG</button>
    </div>
  </div>
</div>

<script>
/* ---------------- Keys & State ---------------- */
const LS_ANALYST_V2 = 'qa_analyst_db_v2';
const LS_ANALYST_V3 = 'qa_analyst_db_v3_sensory';
const LS_APPROVER = 'qa_approver_db_v3';
const LS_LOGO = 'qa_logo_base64';
const LS_APPROVER_SIG = 'qa_approver_signature_b64';
const LS_PASS = 'qa_approver_password';

let DB = { products: [], audit: [], archive: [] };
let CURRENT_COA_CTX = null;

/* ---------------- Helpers ---------------- */
function now(){ return new Date().toLocaleString(); }
function uid(){ return Math.random().toString(36).slice(2,9); }
function log(type,msg){
  const c = document.getElementById('console');
  const d = document.createElement('div');
  const cls = type==='pass'?'log-pass':(type==='fail'?'log-fail':'log-info');
  d.innerHTML = `<span class='text-xs text-gray-400'>[${now()}]</span> <span class='${cls}'>${msg}</span>`;
  c.appendChild(d); c.scrollTop = c.scrollHeight;
  DB.audit = DB.audit || []; DB.audit.push({ ts: new Date().toISOString(), actor:'Approver', type, msg });
  saveDB();
}
function saveDB(){ try{ localStorage.setItem(LS_APPROVER, JSON.stringify(DB)); }catch(e){} }
function setLogo(file){ if(!file) return; const r=new FileReader(); r.onload=()=>{ localStorage.setItem(LS_LOGO, r.result); document.getElementById('logoImg').src=r.result; log('info','Logo updated'); }; r.readAsDataURL(file); }
function loadLogo(){ const b = localStorage.getItem(LS_LOGO)||''; if(b) document.getElementById('logoImg').src=b; }
function setApproverSig(file){ if(!file) return; const r=new FileReader(); r.onload=()=>{ localStorage.setItem(LS_APPROVER_SIG, r.result); const img=document.getElementById('approverSigPreview'); img.src=r.result; img.classList.remove('hidden'); log('info','Approver signature updated'); }; r.readAsDataURL(file); }
function loadApproverSig(){ const b = localStorage.getItem(LS_APPROVER_SIG)||''; if(b){ const img=document.getElementById('approverSigPreview'); img.src=b; img.classList.remove('hidden'); } }
function getPass(){ return localStorage.getItem(LS_PASS) || 'admin123'; }

/* ---------------- JSON Ingest ---------------- */
function mergeIncoming(incoming){
  if(Array.isArray(incoming.products)){
    if(!incoming.audit) incoming.audit=[];
    if(!incoming.archive) incoming.archive=[];
    DB = incoming;
    log('pass','Imported full Analyst DB JSON');
    return;
  }
  if(!(incoming.product && incoming.batch)) throw new Error('Invalid schema: missing product/batch');
  const prodId = incoming.product.id || incoming.product.product_id || uid();
  let prod = DB.products.find(p=>p.id===prodId);
  if(!prod){
    prod = { id: prodId, name: incoming.product.name || incoming.product.product_name || 'Unnamed', parameters: [], batches: [] };
    DB.products.push(prod);
  }
  const standards = {};
  const resultsMap = {};
  if(Array.isArray(incoming.parameters) && incoming.parameters.length){
    for(const prm of incoming.parameters){
      const pname = prm.parameter || prm.name;
      if(!pname) continue;
      if(prm.standard && typeof prm.standard === 'object'){
        if('min' in prm.standard || 'max' in prm.standard){
          standards[pname] = { min: (prm.standard.min ?? null), max: (prm.standard.max ?? null), unit: (prm.standard.unit||''), stdText: prm.standard.text || '', type: prm.type || 'numeric' };
        } else if('text' in prm.standard){
          standards[pname] = { min: null, max: null, unit: '', stdText: prm.standard.text || '', type: prm.type || 'sensory' };
        } else {
          standards[pname] = { min: null, max: null, unit: '', stdText: '', type: prm.type || null };
        }
      } else {
        standards[pname] = { min: prm.min ?? null, max: prm.max ?? null, unit: prm.unit||'', stdText: prm.stdText||'', type: prm.type||null };
      }
      if(prm.result !== undefined){
        resultsMap[pname] = prm.result;
      } else if(prm.value !== undefined){
        resultsMap[pname] = prm.value;
      }
    }
  } else {
    if(incoming.results && typeof incoming.results === 'object'){
      for(const k of Object.keys(incoming.results)) resultsMap[k] = incoming.results[k];
    }
    if(incoming.standards && typeof incoming.standards === 'object'){
      for(const k of Object.keys(incoming.standards)){
        const s = incoming.standards[k]||{};
        standards[k] = { min: s.min ?? null, max: s.max ?? null, unit: s.unit||'', stdText: s.stdText||'', type: s.type||null };
      }
    }
  }
  const ensureParam = (name)=>{
    let p = prod.parameters.find(x=>x.name===name);
    if(!p){
      const s = standards[name]||{};
      const type = s.type || ((resultsMap[name]!==undefined && !isNaN(parseFloat(resultsMap[name]))) ? 'numeric' : 'sensory');
      p = { id: uid(), name, min: s.min ?? null, max: s.max ?? null, unit: s.unit||'', type, stdText: s.stdText||'' };
      prod.parameters.push(p);
    } else {
      const s = standards[name]||{};
      if(p.min==null && s.min!=null) p.min=s.min;
      if(p.max==null && s.max!=null) p.max=s.max;
      if(!p.unit && s.unit) p.unit=s.unit;
      if(!p.stdText && s.stdText) p.stdText=s.stdText;
      if(!p.type && s.type) p.type=s.type;
    }
  };
  for(const k of Object.keys(resultsMap)) ensureParam(k);
  for(const k of Object.keys(standards)) ensureParam(k);
  const b = incoming.batch || {};
  const batchObj = {
    id: b.id || b.batch_id || uid(),
    batch: b.batch_no || b.batch || b.batchNumber || 'N/A',
    date: b.production_date || b.productionDate || b.date || '',
    analysisDate: b.analysis_date || b.analysisDate || b.analysis_date || '',
    analyst: b.analyst || b.analyst_name || '',
    disposition: (b.disposition || b.remarks || b.remark || incoming.disposition || incoming.remarks || ''),
    signature: b.signature_base64 || b.signature || '',
    results: resultsMap,
    createdAt: b.created_at || b.createdAt || new Date().toISOString(),
    approved: false
  };
  if(Object.keys(resultsMap).length===0 && Array.isArray(incoming.parameters)){
    for(const prm of incoming.parameters){
      const pname = prm.parameter || prm.name; if(!pname) continue;
      if(prm.result !== undefined) batchObj.results[pname]=prm.result;
      else if(prm.value !== undefined) batchObj.results[pname]=prm.value;
    }
  }
  prod.batches.push(batchObj);
  log('pass', `Imported batch JSON for ${prod.name} / ${batchObj.batch}`);
}

/* ---------------- Evaluation ---------------- */
function evalBatch(p,b){
  if(!p.parameters.length) return {status:'n/a', pass:0, fail:0};
  let allHave=true, allPass=true;
  for(const prm of p.parameters){
    const v = b.results ? b.results[prm.name] : undefined;
    if(v===undefined || v===''){ allHave=false; continue; }
    if(prm.type === 'numeric'){
      const num = (typeof v==='number')?v:parseFloat(v);
      if(isNaN(num)){ allHave=false; continue; }
      if(prm.min!=null && num < prm.min) allPass=false;
      if(prm.max!=null && num > prm.max) allPass=false;
    } else {
      if(prm.stdText && String(v).trim() !== String(prm.stdText).trim()) allPass=false;
    }
  }
  if(!allHave) return {status:'partial', pass:0, fail:0};
  return allPass?{status:'pass', pass:1, fail:0}:{status:'fail', pass:0, fail:1};
}

/* ---------------- Rendering ---------------- */
function renderAll(){ renderDashboard(); renderProducts(); document.getElementById('generatedTime').textContent = now(); }

function renderDashboard(){
  const products = DB.products || [];
  const metricProducts = products.length;
  const metricParams = products.reduce((a,p)=>a+(p.parameters?.length||0),0);
  const metricBatches = products.reduce((a,p)=>a+(p.batches?.length||0),0);
  let pass=0, fail=0;
  const perDay = {};
  for(const p of products){
    for(const b of (p.batches||[])){
      const stat = evalBatch(p,b); pass+=stat.pass; fail+=stat.fail;
      const d = b.date || 'Unspecified';
      perDay[d] = perDay[d] || {count:0, pass:0, fail:0};
      perDay[d].count += 1; perDay[d].pass += stat.pass; perDay[d].fail += stat.fail;
    }
  }
  document.getElementById('metricProducts').textContent = metricProducts;
  document.getElementById('metricParams').textContent = metricParams;
  document.getElementById('metricBatches').textContent = metricBatches;
  document.getElementById('metricPassFail').textContent = `${pass} / ${fail}`;

  const wrap = document.getElementById('dailyTableWrap');
  const days = Object.keys(perDay).sort();
  if(!days.length){ wrap.innerHTML = '<div class="text-sm text-gray-500">No data yet.</div>'; return; }
  let html = '<table class="w-full border mt-2 text-sm"><thead><tr class="bg-gray-100">'+
             '<th class="border p-2 text-left">Production Date</th><th class="border p-2">Samples</th><th class="border p-2">Pass</th><th class="border p-2">Fail</th></tr></thead><tbody>';
  for(const d of days){
    const r = perDay[d];
    html += `<tr><td class="border p-2">${d}</td><td class="border p-2 text-center">${r.count}</td><td class="border p-2 text-center">${r.pass}</td><td class="border p-2 text-center">${r.fail}</td></tr>`;
  }
  html += '</tbody></table>';
  wrap.innerHTML = html;
}

function renderProducts(){
  const q = (document.getElementById('search').value||'').toLowerCase();
  const wrap = document.getElementById('productsWrap');
  if(!DB.products?.length){ wrap.innerHTML = '<div class="text-sm text-gray-500">No products yet.</div>'; return; }
  wrap.innerHTML = '';
  for(const p of DB.products){
    const matched = p.name.toLowerCase().includes(q) || (p.parameters||[]).some(pm=>pm.name.toLowerCase().includes(q));
    if(!matched && q) continue;
    const card = document.createElement('div'); card.className='bg-white rounded-xl shadow p-4';
    const header = document.createElement('div'); header.className='flex items-center justify-between';
    header.innerHTML = `<div><h3 class="font-semibold">${p.name}</h3><div class="text-xs text-gray-500">${(p.parameters||[]).length} parameters · ${(p.batches||[]).length} batches</div></div>`;
    card.appendChild(header);

    if(p.parameters?.length){
      const chips = document.createElement('div'); chips.className='flex flex-wrap gap-2 mt-2';
      for(const prm of p.parameters){
        const range = (prm.type==='numeric' && (prm.min!=null||prm.max!=null)) ? ` [${prm.min ?? '-'}–${prm.max ?? '-'} ${prm.unit||''}]` : (prm.stdText?` • Std: ${prm.stdText}`:'');
        const el = document.createElement('span'); el.className='text-xs bg-gray-100 rounded px-2 py-1'; el.textContent=`${prm.name}${range}`; chips.appendChild(el);
      }
      card.appendChild(chips);
    }

    const list = document.createElement('div'); list.className='mt-3 space-y-2';
    for(const b of (p.batches||[])){
      const stat = evalBatch(p,b);
      const badge = stat.status==='pass'?'bg-green-100 text-green-700':(stat.status==='fail'?'bg-red-100 text-red-700':(stat.status==='partial'?'bg-yellow-100 text-yellow-700':'bg-gray-100 text-gray-700'));
      const row = document.createElement('div'); row.className='flex items-center justify-between border rounded p-2';
      row.innerHTML = `<div class="text-sm">
        <div class="font-medium">${p.name} — Batch ${b.batch}</div>
        <div class="text-xs text-gray-500">Prod: ${b.date||'-'} · Analysis: ${b.analysisDate||'-'} · Analyst: ${b.analyst||'-'} · Disp: ${b.disposition||'-'}</div>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs ${badge} px-2 py-1 rounded">${stat.status.toUpperCase()}</span>
        <button class="px-2 py-1 text-xs bg-gray-200 rounded" onclick="openCOA('${p.id}','${b.id}')">Preview COA</button>
        <button class="px-2 py-1 text-xs bg-indigo-600 text-white rounded" onclick="approveBatch('${p.id}','${b.id}')">${b.approved?'Revoke':'Approve'}</button>
        <button class="px-2 py-1 text-xs bg-yellow-300 rounded" onclick="toggleEditResults('${p.id}','${b.id}', this)">Edit Results</button>
      </div>`;
      list.appendChild(row);
    }
    card.appendChild(list);
    wrap.appendChild(card);
  }
}

/* ---------------- Approvals ---------------- */
function approveBatch(pid,bid){
  const p = DB.products.find(x=>x.id===pid); if(!p) return;
  const b = p.batches.find(x=>x.id===bid); if(!b) return;
  b.approved = !b.approved;
  log('info', `${b.approved?'Approved':'Revoked'} ${p.name} / ${b.batch}`);
  saveDB(); renderAll();
}

/* ---------------- Edit Results / Parameters (inline) ---------------- */
function toggleEditResults(pid, bid, caller){
  const p = DB.products.find(x=>x.id===pid); if(!p) return alert('Product not found');
  const b = p.batches.find(x=>x.id===bid); if(!b) return alert('Batch not found');

  let container = caller.__editContainer;
  if(container && container.parentNode){ container.classList.toggle('hidden'); return; }

  container = document.createElement('div');
  container.className='border rounded p-3 mt-2 bg-gray-50';
  container.innerHTML = buildEditFormHTML(p,b);
  let row = caller.closest('div.flex.items-center.justify-between');
  if(!row) row = caller.parentNode;
  row.parentNode.insertBefore(container, row.nextSibling);
  caller.__editContainer = container;

  container.querySelector('.btnCancelEdit')?.addEventListener('click', ()=>{ container.classList.add('hidden'); });
  container.querySelector('.btnAddParam')?.addEventListener('click', ()=> addParamRow(container));
  container.querySelector('.btnSaveEdit')?.addEventListener('click', ()=> saveEditForm(pid,b.id,container));
  container.querySelectorAll('.btnDeleteParam').forEach(btn=>{ btn.addEventListener('click', (e)=>{ const r=e.target.closest('tr'); r.parentNode.removeChild(r); }); });
}

function buildEditFormHTML(p,b){
  const approverName = document.getElementById('approverName').value || '';
  let html = `<div class="mb-2 grid grid-cols-3 gap-2">
    <div><label class="text-xs">Analyst</label><input class="w-full border rounded p-1 analystNameInput" value="${b.analyst || ''}"/></div>
    <div><label class="text-xs">Approver</label><input class="w-full border rounded p-1 approverNameInput" value="${approverName}"/></div>
    <div><label class="text-xs">Disposition (read-only)</label><input class="w-full border rounded p-1 dispositionRead" value="${b.disposition || ''}" readonly/></div>
  </div>`;

  html += `<div class="overflow-auto"><table class="w-full text-xs"><thead><tr class="bg-gray-100"><th class="border p-1">Parameter</th><th class="border p-1">Min</th><th class="border p-1">Max</th><th class="border p-1">Unit</th><th class="border p-1">Std Text</th><th class="border p-1">Result</th><th class="border p-1">Delete</th></tr></thead><tbody>`;

  for(const prm of p.parameters){
    const val = (b.results && (b.results[prm.name]!==undefined))?b.results[prm.name]:'';
    html += `<tr>
      <td class="border p-1"><input class="w-full paramNameInput border rounded p-1" value="${prm.name}"/></td>
      <td class="border p-1"><input class="w-full minInput border rounded p-1" value="${prm.min!=null?prm.min:''}" type="number" step="any"/></td>
      <td class="border p-1"><input class="w-full maxInput border rounded p-1" value="${prm.max!=null?prm.max:''}" type="number" step="any"/></td>
      <td class="border p-1"><input class="w-full unitInput border rounded p-1" value="${prm.unit||''}"/></td>
      <td class="border p-1"><input class="w-full stdTextInput border rounded p-1" value="${prm.stdText||''}"/></td>
      <td class="border p-1"><input class="w-full resultInput border rounded p-1" value="${val}"/></td>
      <td class="border p-1 text-center"><button class="btnDeleteParam px-2 py-1 text-xs bg-red-200 rounded">🗑️</button></td>
    </tr>`;
  }

  html += `</tbody></table></div>`;
  html += `<div class="mt-2 flex gap-2"><button class="btnAddParam px-3 py-1 bg-green-200 rounded text-sm">+ Add Parameter</button><button class="btnSaveEdit px-3 py-1 bg-indigo-600 text-white rounded text-sm">Save Changes</button><button class="btnCancelEdit px-3 py-1 bg-gray-300 rounded text-sm">Cancel</button></div>`;
  return html;
}

function addParamRow(container){
  const tbody = container.querySelector('table tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td class="border p-1"><input class="w-full paramNameInput border rounded p-1" value=""/></td>
      <td class="border p-1"><input class="w-full minInput border rounded p-1" value="" type="number" step="any"/></td>
      <td class="border p-1"><input class="w-full maxInput border rounded p-1" value="" type="number" step="any"/></td>
      <td class="border p-1"><input class="w-full unitInput border rounded p-1" value=""/></td>
      <td class="border p-1"><input class="w-full stdTextInput border rounded p-1" value=""/></td>
      <td class="border p-1"><input class="w-full resultInput border rounded p-1" value=""/></td>
      <td class="border p-1 text-center"><button class="btnDeleteParam px-2 py-1 text-xs bg-red-200 rounded">🗑️</button></td>`;
  tbody.appendChild(tr);
  tr.querySelector('.btnDeleteParam').addEventListener('click', ()=> tr.remove());
}

function saveEditForm(pid,bid,container){
  const p = DB.products.find(x=>x.id===pid); if(!p) return alert('Product not found');
  const b = p.batches.find(x=>x.id===bid); if(!b) return alert('Batch not found');
  const analystVal = container.querySelector('.analystNameInput')?.value || '';
  const approverVal = container.querySelector('.approverNameInput')?.value || '';
  b.analyst = analystVal;
  document.getElementById('approverName').value = approverVal;
  const rows = Array.from(container.querySelectorAll('table tbody tr'));
  const newParams = [];
  const newResults = {};
  for(const r of rows){
    const name = r.querySelector('.paramNameInput')?.value?.trim();
    if(!name) continue;
    const min = r.querySelector('.minInput')?.value;
    const max = r.querySelector('.maxInput')?.value;
    const unit = r.querySelector('.unitInput')?.value || '';
    const stdText = r.querySelector('.stdTextInput')?.value || '';
    const result = r.querySelector('.resultInput')?.value || '';
    const paramObj = {
      id: (p.parameters.find(pp=>pp.name===name)?.id) || ('p_'+Math.random().toString(36).slice(2,9)),
      name,
      min: (min==='')?null:parseFloat(min),
      max: (max==='')?null:parseFloat(max),
      unit,
      stdText,
      type: (stdText && String(stdText).trim()!=='') ? 'sensory' : ((min!==''||max!=='') ? 'numeric' : 'numeric')
    };
    newParams.push(paramObj);
    if(result!==''){
      if(paramObj.type==='numeric' && !isNaN(parseFloat(result))) newResults[name]=parseFloat(result);
      else newResults[name]=result;
    }
  }
  p.parameters = newParams;
  b.results = newResults;
  saveDB();
  renderAll();
  container.classList.add('hidden');
  log('info', `Saved edits for ${p.name} / ${b.batch}`);
}

/* ---------------- COA Preview & Export ---------------- */
function openCOA(pid,bid){
  const p = DB.products.find(x=>x.id===pid); if(!p) return;
  const b = p.batches.find(x=>x.id===bid); if(!b) return;
  const logo = localStorage.getItem(LS_LOGO) || '';
  const approverSig = localStorage.getItem(LS_APPROVER_SIG) || '';
  const approverName = document.getElementById('approverName').value || '';

  CURRENT_COA_CTX = { pid, bid };

  // Build condensed rows (Standard compressed into one column)
  let rowsCondensed = '';
  for(const prm of p.parameters){
    const v = b.results ? b.results[prm.name] : '';
    let evalTxt = '';
    if(prm.type==='numeric'){
      const num = (typeof v==='number')?v:parseFloat(v);
      if(v==='' || isNaN(num)) evalTxt='—';
      else if((prm.min!=null && num<prm.min) || (prm.max!=null && num>prm.max)) evalTxt='FAIL';
      else evalTxt='PASS';
    } else {
      if(!prm.stdText) evalTxt='—';
      else evalTxt = (String(v).trim()===String(prm.stdText).trim())?'PASS':'FAIL';
    }
    const standardCell = (prm.type==='numeric') ? `${prm.min != null ? prm.min : '-'} – ${prm.max != null ? prm.max : '-'} ${prm.unit||''}` : (prm.stdText || '-');
    rowsCondensed += `<tr>
      <td>${prm.name}</td>
      <td class="text-center">${standardCell}</td>
      <td class="text-center">${(v ?? '')}</td>
      <td class="text-center font-semibold ${evalTxt==='PASS'?'text-green-700':(evalTxt==='FAIL'?'text-red-700':'text-gray-500')}">${evalTxt}</td>
    </tr>`;
  }

  const html = `
  <div id="coaPage" class="coa-page p-6">
    <div class="flex items-start gap-3">
      <img src="${logo}" class="h-14 w-auto border rounded bg-white" alt="Logo"/>
      <div>
        <div class="text-xl font-bold">Certificate of Analysis</div>
      </div>
    </div>

    <div class="border rounded p-3 mt-4 text-sm">
      <div><span class="font-semibold">Product:</span> ${p.name}</div>
      <div><span class="font-semibold">Batch No.:</span> ${b.batch}</div>
      <div><span class="font-semibold">Production Date:</span> ${b.date || '-'}</div>
      <div><span class="font-semibold">Analysis Date:</span> ${b.analysisDate || '-'}</div>
    </div>

    <div class="mt-4">
      <div class="text-sm font-semibold mb-2">Parameters </div>
      <table class="w-full coa-table text-sm">
        <thead class="bg-gray-100"><tr><th>Parameter</th><th>Standard</th><th>Result</th><th>Evaluation</th></tr></thead>
        <tbody>${rowsCondensed || '<tr><td colspan="4" class="text-center text-gray-500">No parameters</td></tr>'}</tbody>
      </table>
    </div>

    <div class="grid grid-cols-2 gap-3 mt-6">
      <div class="border rounded p-3 text-sm">
        <div class="font-semibold mb-2">Analyzed by</div>
        ${b.signature ? `<img src="${b.signature}" class="h-12 object-contain border mb-1"/>` : '<div class="text-xs text-gray-400 mb-2">No analyst signature</div>'}
        <div>${b.analyst || '-'}</div>
      </div>
      <div class="border rounded p-3 text-sm">
        <div class="font-semibold mb-2">Approved by</div>
        ${approverSig ? `<img src="${approverSig}" class="h-12 object-contain border mb-1"/>` : '<div class="text-xs text-gray-400 mb-2">No approver signature</div>'}
        <div>${approverName || '-'}</div>
      </div>
    </div>

    <div class="mt-4 text-sm">
      <div><span class="font-semibold">Notes / Disposition:</span> ${b.disposition || '-'}</div>
    </div>

<!-- ADD FOOTER HERE -->
    <div class="mt-6 text-xs text-gray-500 text-center border-t pt-2">
      6409 Camia Corner Gumamela Streets 1200 Makati City Metro Manila
    </div>

    <!-- store simplified rows for export -->
    <div id="coa_export_data" style="display:none" data-rows-final='${encodeURIComponent(rowsCondensed)}'></div>
  </div>`;

  document.getElementById('coaWrap').innerHTML = html;
  const modal = document.getElementById('coaModal');
  modal.classList.remove('hidden'); modal.classList.add('flex');
}

/* Export: build simplified final COA then print to PDF/PNG */

async function saveCoaAs(format){
  if(!CURRENT_COA_CTX) return alert('No COA to export');

  const { pid, bid } = CURRENT_COA_CTX;
  const p = DB.products.find(x=>x.id===pid); if(!p) return;
  const b = p.batches.find(x=>x.id===bid); if(!b) return;

  // Build filename: ProductName_ProductionDate_BatchNo
  const safeProduct = (p.name || 'Product').replace(/\s+/g, '_');
  const safeDate = (b.date || 'Date').replace(/[^\w-]/g, '_');
  const safeBatch = (b.batch || 'Batch').replace(/\s+/g, '_');
  const fileName = `${safeProduct}_${safeDate}_${safeBatch}`;

  // Capture preview node
  const node = document.getElementById('coaPage');
  if(!node) return alert('No COA content found');

  const canvas = await html2canvas(node, { scale: 2, useCORS: true });

  if(format==='png'){
    const link = document.createElement('a');
    link.href = canvas.toDataURL('image/png');
    link.download = `${fileName}.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  } else {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation:'p', unit:'pt', format:'a4' });
    const imgData = canvas.toDataURL('image/png');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const ratio = Math.min(pageWidth / canvas.width, pageHeight / canvas.height);
    const w = canvas.width * ratio;
    const h = canvas.height * ratio;
    const x = (pageWidth - w) / 2;
    const y = 20;
    pdf.addImage(imgData,'PNG',x,y,w,h);
    pdf.save(`${fileName}.pdf`);
  }

  // Close modal
  document.getElementById('coaModal').classList.add('hidden');
  CURRENT_COA_CTX = null;
}
/* ---------------- Import / Load functions ---------------- */
function importJSONFile(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const incoming = JSON.parse(reader.result);
      if(!incoming || typeof incoming !== 'object') throw new Error('Invalid JSON');
      mergeIncoming(incoming);
      saveDB(); renderAll();
    }catch(e){ alert('Import failed: '+e.message); log('fail', 'Import failed: '+e.message); }
  };
  reader.readAsText(file);
}

function loadFromLocalAnalyst(){
  try{
    const raw2 = localStorage.getItem(LS_ANALYST_V2);
    const raw3 = localStorage.getItem(LS_ANALYST_V3);
    const raw = raw3 || raw2;
    if(!raw) return alert('No Analyst data found in this browser. Import JSON instead.');
    const incoming = JSON.parse(raw);
    if(!incoming || !Array.isArray(incoming.products)) return alert('Invalid Analyst schema.');
    if(!incoming.audit) incoming.audit=[]; if(!incoming.archive) incoming.archive=[];
    DB = incoming; saveDB(); renderAll(); log('pass','Loaded Analyst data from LocalStorage');
  }catch(e){ alert('Load failed'); }
}

/* ---------------- Exports ---------------- */
function exportDashboard(){
  const rows=[['Production Date','Samples','Pass','Fail']];
  const perDay={};
  for(const p of (DB.products||[])){
    for(const b of (p.batches||[])){
      const stat = evalBatch(p,b);
      const d = b.date || 'Unspecified';
      perDay[d] = perDay[d] || {count:0, pass:0, fail:0};
      perDay[d].count++; perDay[d].pass+=stat.pass; perDay[d].fail+=stat.fail;
    }
  }
  for(const d of Object.keys(perDay).sort()){ const r=perDay[d]; rows.push([d,r.count,r.pass,r.fail]); }
  const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(rows); XLSX.utils.book_append_sheet(wb, ws, 'Summary'); XLSX.writeFile(wb, 'approver_dashboard.xlsx');
  log('pass','Exported dashboard');
}

function exportDatabase(){
  const wb = XLSX.utils.book_new();
  for(const p of (DB.products||[])){
    const rows = [];
    for(const b of (p.batches||[])){
      for(const prm of (p.parameters||[])){
        const res = b.results && b.results[prm.name] ? b.results[prm.name] : '';
        rows.push({ Product: p.name, Batch: b.batch, Production_Date: b.date, Analysis_Date: b.analysisDate, Analyst: b.analyst, Parameter: prm.name, Type: prm.type, Standard: (prm.type==='numeric'?`${prm.min}-${prm.max}`:prm.stdText||''), Unit: prm.unit||'', Result: res, Disposition: b.disposition||'' });
      }
    }
    const ws = XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, p.name.substring(0,31));
  }
  XLSX.writeFile(wb, 'approver_database.xlsx');
  log('pass','Exported approver database');
}

function exportAudit(){
  const rows = [['Timestamp','Actor','Type','Message']];
  for(const a of DB.audit||[]){ rows.push([a.ts,a.actor,a.type,a.msg]); }
  const ws = XLSX.utils.aoa_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Audit'); XLSX.writeFile(wb,'approver_audit.xlsx');
  log('pass','Exported audit');
}

/* ---------------- Init / Events ---------------- */
document.getElementById('logoUpload').addEventListener('change', (e)=> setLogo(e.target.files[0]));
document.getElementById('approverSig').addEventListener('change', (e)=> setApproverSig(e.target.files[0]));
document.getElementById('importJSON').addEventListener('change', (e)=> importJSONFile(e.target.files[0]));
document.getElementById('btnFromLocal').addEventListener('click', loadFromLocalAnalyst);
document.getElementById('btnExportDash').addEventListener('click', exportDashboard);
document.getElementById('btnExportDB').addEventListener('click', exportDatabase);
document.getElementById('btnExportAudit').addEventListener('click', exportAudit);
document.getElementById('btnReset').addEventListener('click', ()=>{ if(confirm('Reset approver DB?')){ DB={products:[],audit:[]}; saveDB(); renderAll(); }});

document.getElementById('overlayLoginBtn').addEventListener('click', ()=>{
  const val = document.getElementById('overlayPass').value || '';
  if(val === getPass()){ document.getElementById('loginOverlay').classList.add('hidden'); document.getElementById('mainApp').classList.remove('hidden'); loadLogo(); loadApproverSig(); loadFromLocalAnalyst(); renderAll(); log('pass','Approver logged in'); }
  else { alert('Invalid password'); }
});

document.getElementById('btnSavePDF').addEventListener('click', ()=> saveCoaAs('pdf'));
document.getElementById('btnSavePNG').addEventListener('click', ()=> saveCoaAs('png'));
document.getElementById('closeCoa').addEventListener('click', ()=>{ document.getElementById('coaModal').classList.add('hidden'); CURRENT_COA_CTX = null; });

document.getElementById('search').addEventListener('input', ()=> renderProducts());

document.getElementById('btnRefresh').addEventListener('click', ()=> renderAll());

// Auto-show login overlay
(function(){ document.getElementById('loginOverlay').classList.remove('hidden'); document.getElementById('mainApp').classList.add('hidden'); })();

</script>
</body>
</html>
